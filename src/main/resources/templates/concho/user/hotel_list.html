<!-- 이 코드를 복붙해서 사용해주세요 -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="~{common/head-top :: head-top-fragment}"><title>감자팀</title></head>
<style>

    .card-img-my{
        border-radius: 3rem 3rem 3rem 3rem;
        height: 25rem;
        width: 40%;
        margin-right: 1.3rem;
    }
    .myedu-cont{
        width: 38%;
    }
    .text-wrap-1 {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.3rem;
    }
    @media (max-width: 1000px) {
        .my-text{
            width: 100px;
        }
        .card-img-my{
            height: 200px;
            width: 50%;
        }
        .myedu-cont{
            margin-top: 1.3rem;
            width: 90%;
        }
    }
    @media (max-width: 640px) {
        .my-text{
            width: 100px;
        }
        .card-img-my{
            height: 200px;
            width: 100%;
        }
        .myedu-cont{
            margin-top: 1.3rem;
            width: 90%;
        }
    }
    .myedu-area{
        display: none;
    }
</style>
<body>
<div th:replace="~{common/head :: head-fragment}"></div>

<!-- [E]tedu-N3 -->
<main class="th-layout-main ">
    <!-- [S]tedu-N47 -->
    <div class="tedu-N47" data-bid="CulXIc4GvR">
        <div class="content-inner">
            <div class="content-container">
                <section class="myedu-wrap">
                    <div class="title-wrap-1" style="display: flex; align-items: center; justify-content: space-between;">
                        <h3 class="cont-title">검색된 숙박 목록</h3>
                        <button type="button" style="border-radius: 3rem 3rem 3rem 3rem; width: 80px; height: 40px; background-color: #009EFF"
                                class="tedu-btn tedu-btn-light add-cart" onclick="location.href='/user/concho/service/search'">뒤로가기</button>
                    </div>
                    <div class="tab-menu-wrap">
                        <div class="tab-menu active">
                            <a href="javascript:void(0)">
                                <span>전체 목록</span>&nbsp;
                                <strong style="color: blue" id="hotel-cnt"></strong>
                            </a>
                        </div>
                        <div class="tab-menu">
                            <a href="javascript:void(0)">
                                <span>최저가순</span>
                            </a>
                        </div>
                        <div class="tab-menu">
                            <a href="javascript:void(0)">
                                <span>거리순</span>
                            </a>
                        </div>
                        <div class="tab-menu">
                            <a href="javascript:void(0)">
                                <span>별점순</span>
                            </a>
                        </div>
                    </div>
                    <div class="myedu-cont-wrap">
                        <h1 id="message-my" style="margin-bottom: 3rem">정보를 가져오는 중입니다....</h1>
                        <th:block th:if="${hotelList != null && !hotelList.isEmpty()}">
                            <div class="myedu-area" th:each="hotel : ${hotelList}" th:id="${hotel.getHotelId()}" style="display: none">
                                <img class="card-img-my" src="/common/images/hotel_base.png" alt="이미지">
                                <div class="myedu-cont">
                                    <div class="text-area" >
                                        <strong class="cate" th:text="${hotel.getIataCode()}"></strong>
                                        <span th:text="${hotel.getCountryCode()}"></span>
                                        <div class="title" th:text="${hotel.getName()}"></div>
                                    </div>
                                </div>
                                <button type="button" class="tedu-btn tedu-btn-dark btn-link"
                                        th:data-hotel-id-key="${hotel.getIdKey()}"
                                        th:data-hotel-id="${hotel.getHotelId()}"
                                        th:data-iata-code="${iataCode}"
                                        th:data-start-date="${startDate}"
                                        th:data-end-date="${endDate}"
                                        th:data-person-cnt="${personCnt}">
                                    <span class="my-text">숙박 상세보기</span>
                                </button>
                            </div>
                        </th:block>
                        <button type="button" class="tedu-btn" id="more" style="width: 50%;" th:align="center">
                            <span class="my-text">더보기</span>
                        </button>
                    </div>
                </section>
            </div>
        </div>
    </div>
    <!-- [E]tedu-N47 -->
</main>

<div class="tedu-N17" data-bid="fjlxiC75U0">
    <th:block th:replace="~{common/footer :: footer-fragment}"></th:block>
</div>
<th:block th:replace="~{common/footer-down :: footer-js-fragment}"></th:block>
<script th:inline="javascript">
    let hotelInfoList = /*[[${hotelList}]]*/ null;
    let iataCode = /*[[${iataCode}]]*/ null;
    let $viewBox = $('.myedu-cont-wrap');
    let $hotelCnt = $('#hotel-cnt');

    let hotelReqCnt = 0;
    let hotelLoadingTrueCnt = 0;
    let endHotelLoadingCnt = 0;
    let startIdx = 0;
    let endIdx = 20;
    let isLoading = false;

    console.log(hotelInfoList);
    function getHotelInfoAndCrawling(startIndex, endIndex) {
        if(isLoading){
            alert('호텔 정보를 로딩중입니다..');
            return false;
        }
        isLoading = true;
        // 호텔 list 가 startIndex 보다 작을때
        if(hotelInfoList.length < startIndex){
            alert('모든 호텔 정보를 가져왔습니다.');
            return false;
        // 호텔 list 가 startIndex , endIndex 사이일때
        }else if(startIndex <= hotelInfoList.length && hotelInfoList.length <= endIndex){
            alert('마지막 호텔 리스트를 가져옵니다.');
        }

        console.log('크롤링 시작 : ' + startIndex + " " + endIndex);
        $.each(hotelInfoList.slice(startIndex, endIndex), function (index, hotel) {
            console.log('크롤링 for 문');
            hotelReqCnt++;
            let formData = new FormData();

            formData.append('hotelName', hotel.name);
            formData.append('iataCode', iataCode);
            formData.append('hotelId', hotel.hotelId);

            ajaxGo('/concho/crawling', formData, function (response) {
                endHotelLoadingCnt++;
                if(endHotelLoadingCnt === hotelReqCnt){
                    $('#message-my').hide();
                    isLoading = false;
                }
                if (response.result === 'ok') {
                    hotelLoadingTrueCnt++;
                    let $box = $viewBox.find(`#${response.hotelId}`);
                    let $img = $box.find('.card-img-my');
                    $img.attr('src', response.imgUrl);
                    $box.show();
                    $hotelCnt.text(Number($hotelCnt.text()) + 1);
                    //console.log(hotel.name + " 호텔 로딩 완료 " + response.hotelId);
                } else {
                    //console.log(`#${hotel.hotelId}`);
                    //let $box = $viewBox.find(`#${response.hotelId}`);
                    //$box.hide();
                    //console.log(hotel.name + " 호텔 숨기기 " + response.hotelId);
                }
            });
        });
    }
    $(document).on('click', '#more', function (){
        endIdx += 10;
        startIdx = (endIdx-10);
        getHotelInfoAndCrawling(startIdx, endIdx);
    });


    $(document).ready(function() {
        // 초기 로딩
        getHotelInfoAndCrawling(startIdx, endIdx);


        $('.btn-link').on('click', function() {
            let hotelIdKey = $(this).data('hotel-id-key');
            let hotelId = $(this).data('hotel-id');
            let iataCode = $(this).data('iata-code');
            let startDate = $(this).data('start-date');
            let endDate = $(this).data('end-date');
            let personCnt = $(this).data('person-cnt');
            // 동적으로 form 생성
            let form = $('<form></form>');
            form.attr("method", "post");
            form.attr("action", "/user/concho/service/hotel-info");
            // 호텔 ID를 hidden input으로 추가
            let hiddenField =
                $('<input></input>').attr("type", "hidden").attr("name", "hotelIdKey").attr("value", hotelIdKey);
            let hiddenField1 =
                $('<input></input>').attr("type", "hidden").attr("name", "hotelId").attr("value", hotelId);
            let hiddenField2 =
                $('<input></input>').attr("type", "hidden").attr("name", "iataCode").attr("value", iataCode);
            let hiddenField3 =
                $('<input></input>').attr("type", "hidden").attr("name", "startDate").attr("value", startDate);
            let hiddenField4 =
                $('<input></input>').attr("type", "hidden").attr("name", "endDate").attr("value", endDate);
            let hiddenField5 =
                $('<input></input>').attr("type", "hidden").attr("name", "personCnt").attr("value", personCnt);

            form.append(hiddenField);
            form.append(hiddenField1);
            form.append(hiddenField2);
            form.append(hiddenField3);
            form.append(hiddenField4);
            form.append(hiddenField5);

            // form을 body에 추가하고 제출
            $(document.body).append(form);
            form.submit();
        });


    });


    function ajaxGo(url, formData, callback){
        let responseResult = null;
        let baseUrl = window.location.origin;
        $.ajax({
            url: baseUrl + url,
            type: 'POST',
            data: formData,
            async: true,
            contentType: false,
            processData: false,
            success: function(response) {
                if (callback) {
                    callback(response);
                }
            },
            error: function(error) {
                //alert('통신 오류: ' + error);
            }
        });
        return responseResult;
    }
</script>
</body>